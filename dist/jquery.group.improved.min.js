/* jQuery Group | Copyright (c) Teijo Laine 2017 | Licenced under the MIT licence */

(function(){!function(t){var e,a,n,r,i,o,u,s,d,c,l,m,p,f,h,v,b,g,w,y,S,B,V,C,x,E,k;y={win:3,tie:1,loss:0},v=function(t){return t-1+t%2},E=function(t){var e;return h.test(t)?(e=parseInt(t),isNaN(e)?null:e):null},n=function(e){return t(e.currentTarget)},a=function(t){return[t,n(t)]},x=function(t,e){return t.findIndex(function(t){return t.id===e.id})},k=function(t){return{teams:t.participants.value().map(function(t){var e,a;return{id:t.id,name:t.name,format:null!=(e=t.format)?e:"",data:null!=(a=t.data)?a:{}}}),matches:t.matches.map(function(e){return{a:{team:x(t.participants,e.a.team),score:e.a.score},b:{team:x(t.participants,e.b.team),score:e.b.score},round:e.round}}).value()}},c=function(t,e){return t.map(function(t){var a,n,r,i,o,u;return n=e.filter(function(t){return null!==t.a.score&&null!==t.b.score}).filter(function(e){return e.a.team===t||e.b.team===t}).map(function(e){return e.a.team===t?{ownScore:e.a.score,opponentScore:e.b.score}:{ownScore:e.b.score,opponentScore:e.a.score}}),i=n.reduce(function(t,e){return t+e.ownScore},0),r=n.reduce(function(t,e){return t+e.opponentScore},0),u=n.filter(function(t){return t.ownScore>t.opponentScore}).size(),a=n.filter(function(t){return t.ownScore<t.opponentScore}).size(),o=n.filter(function(t){return t.ownScore===t.opponentScore}).size(),{team:t,wins:u,losses:a,ties:o,points:u*y.win+o*y.tie+a*y.loss,roundWins:i,roundLosses:r,ratio:i-r}}).sortBy(function(t){return-t.ratio}).sortBy(function(t){return-t.points})},h=new RegExp(/^[0-9]+$/),B='<td>{{wins}}</td> <td>{{losses}}</td> <td>{{ties}}</td> <td>{{points}}</td> <td title="Won {{roundWins}}, lost {{roundLosses}} bouts">{{ratio}}</td>',V=Handlebars.compile('<div class="standings"> <table> <colgroup> <col style="width: 50%"> <col span="5" style="width: 10%"> </colgroup> <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</th><th>&plusmn;</th></tr> {{#each this}} <tr data-teamid="{{team.id}}"><td>{{#if team.label}}{{team.label}}{{else}}{{team.name}}{{/if}}</td>'+B+"</tr> {{/each}} </table> </div>"),S=Handlebars.compile('<div class="standings"> <table> <colgroup> <col style="width: 40%"> <col span="6" style="width: 10%"> </colgroup> <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</th><th>&plusmn;</th><th></th></tr> {{#each this}} <tr><td><input class="name" type="text" data-prev="{{team.name}}" data-teamid="{{team.id}}" value="{{team.name}}" /></td>'+B+'<td class="drop" data-name="{{team.id}}" title="Drop team">&#x2A2F;</td></tr> {{/each}} <tr><td><input class="add" type="text" /></td><td colspan="6"><input type="submit" value="Add" disabled="disabled" /></td></tr> </table> </div>'),b=Handlebars.compile('<div data-roundid="{{this}}" class="round"> {{#if this}} <header>Round {{this}}</header> {{else}} <header>Unassigned</header> {{/if}} </div>'),p=Handlebars.compile('<div data-matchid="{{id}}" class="match" draggable="{{draggable}}"> <div class="team" data-teamid="{{a.team.id}}"> <div class="label">{{a.team.label}}</div> <div class="score {{homeClass}}">{{a.score}}</div> </div> <div class="team" data-teamid="{{b.team.id}}"> <div class="score {{awayClass}}">{{b.score}}</div> <div class="label">{{b.team.label}}</div> </div> </div>'),l=Handlebars.compile('<div data-matchid="{{id}}" class="match" draggable="{{draggable}}"> <div class="team" data-teamid="{{a.team.id}}"> <div class="label">{{a.team.label}}</div> <input type="text" class="score home {{homeClass}}" value="{{a.score}}" /> </div> <div class="team" data-teamid="{{b.team.id}}"> <input type="text" class="score away {{awayClass}}" value="{{b.score}}" /> <div class="label">{{b.team.label}}</div> </div> </div>'),m=function(e,a){var n,r;return r=e.a.score>e.b.score,n={homeClass:r?"win":"lose",awayClass:r?"lose":"win"},t(a(_.extend(n,e)))},g=Handlebars.compile('<header class="roundsHeader">Rounds</header>'),w=Handlebars.compile('<div class="rounds"></div>'),e=function(t){return t.name},s=0,r=function(){return++s},d=0,i=function(){return++d},u=function(t){return d=t.size()>0?t.max("id").value().id:0},C=function(e,a){return function(){var n;return n=t(this).attr("data-teamid"),e.find("[data-teamid="+n+"]").toggleClass("highlight",a)}},o=function(e,o,u,s,d){var f,h,y,B,x,H,z,T,W,A,I,P,j,D,L,R,N,Q;return N=function(t){return e.find("[data-roundid='"+t+"']")},B=function(t){return e.find("[data-matchid='"+t+"']")},s&&e.addClass("read-write"),Q={standings:function(a,r,o,u){var d,c,l,m,p,f,h;return u=u||_([]),s?(f=t(S(u.value())),c=f.find("input[type=submit]"),(p=f.find("input").asEventStream("keyup").map(n).map(function(t){var e,a,n;return n=t.val(),e=t.attr("data-prev"),a=n.length>0&&(!u.map(function(t){return t.team}).pluck("name").contains(n)||e===n),{el:t,value:n,valid:a}}).toProperty()).onValue(function(t){if(t.el.toggleClass("conflict",!t.valid),t.el.hasClass("add"))return t.valid?c.removeAttr("disabled"):c.attr("disabled","disabled")}),m=p.map(function(t){return t.valid}).toProperty(),(l=function(e){return f.find("input."+e).asEventStream("change").filter(m).map(".target").map(t)})("name").onValue(function(t){return r.push({id:parseInt(t.attr("data-teamid")),to:t.val()}),t.attr("data-prev",t.val())}),l("add").map(function(t){return t.val()}).onValue(function(t){return a.push({id:i(),name:t,format:"",data:{}})}),f.find("td.drop").asEventStream("click").map(".target").map(t).map(function(t){return t.attr("data-name")}).onValue(function(t){return o.push(parseInt(t))}),f):(d=t(V(u.value())),h=C.bind(null,e),d.find("[data-teamid]").hover(h(!0),h(!1)),d)},roundsHeader:function(e){var a;return(a=t(g())).asEventStream("click").onValue(function(){return e.toggle()}),a},rounds:t(w()),round:function(e){return t(b(e))},matchEdit:function(t){return m(t,l)},matchView:function(t){return m(t,p)}},y={create:function(t,e){return new function(){var r,i;i=Q.round(e),this.markup=i,s&&(r=0,(e=function(t){return i.asEventStream(t).doAction(".preventDefault")})("dragover").onValue(function(t){}),e("dragenter").map(n).onValue(function(t){0===r&&t.addClass("over"),r++}),e("dragleave").map(n).onValue(function(t){0===--r&&t.removeClass("over")}),e("drop").map(a).onValues(function(e,a){var n,i;r=0,n=e.originalEvent.dataTransfer.getData("Text"),i=B(n),a.append(i),a.removeClass("over"),t.push({match:parseInt(n),round:parseInt(a.attr("data-roundId"))})}))}}},h={create:function(r,i){return new function(){var o,u,d;(i=t.extend({},i)).draggable=(null!=s).toString(),s?(d=Q.matchEdit(i),this.markup=d,(u=function(t){return d.find("input").asEventStream(t)})("keyup").map(n).onValue(function(t){return t.toggleClass("conflict",null===E(t.val()))}),u("change").onValue(function(){var t,e,a;if(t=E(d.find("input.home").val()),e=E(d.find("input.away").val()),null!==t&&null!==e)return a={a:{team:i.a.team,score:t},b:{team:i.b.team,score:e}},r.push(a)}),(o=function(t){return function(e){return d.asEventStream(t).map(".originalEvent").map(a).onValues(e)}})("dragstart")(function(t,a){return t.dataTransfer.setData("Text",i.id),a.css("opacity",.5,""),e.find(".round").addClass("droppable")}),o("dragend")(function(t,a){return a.removeAttr("style"),e.find(".droppable").removeClass("droppable")})):this.markup=Q.matchView(i)}}},H=new Bacon.Bus,P=new Bacon.Bus,D=new Bacon.Bus,L=new Bacon.Bus,z=new Bacon.Bus,j=new Bacon.Bus,x=H.toProperty({participants:_([]),matches:_([])}),f=Q.rounds.append(t(y.create(z,0).markup)),e.append(Q.standings(P)).append(Q.roundsHeader(f)).append(f),T=x.sampledBy(P,function(t,e){var a,n;return t.participants.size()>0&&(a=t.participants.map(function(t){return{id:r(),a:{team:t,score:null},b:{team:e,score:null},round:0}}),t.matches=t.matches.union(a.value())),e.label=new Handlebars.SafeString(d(e)),t.participants.push(e),n=v(t.participants.size()),_(_.range(f.find(".round").length-1,n)).each(function(t){return f.append(y.create(z,t+1).markup)}),t}),A=x.sampledBy(j,function(t,e){var a,n,r;return t.matches.filter(function(t){return t.a.team.id===e||t.b.team.id===e}).map(function(t){return t.id}).forEach(function(t){return B(t).remove()}),r=v(t.participants.size()),t.participants=t.participants.filter(function(t){return t.id!==e}),n=v(t.participants.size()),t.matches=t.matches.filter(function(t){return t.a.team.id!==e&&t.b.team.id!==e}).map(function(t){return t.round>n&&(t.round=0),t}),a=N(0),_(_.range(n+1,r+1)).each(function(t){var e,n;return n=N(t),e=n.find(".match"),a.append(e),n.remove()}),t}),R=x.sampledBy(L,function(t,e){return t.matches=t.matches.map(function(t){return t.a.team.id===e.a.team.id&&t.b.team.id===e.b.team.id?(void 0!==e.round&&(t.round=e.round),t.a.score=e.a.score,t.b.score=e.b.score):t.a.team.id===e.b.team.id&&t.b.team.id===e.a.team.id&&(void 0!==e.round&&(t.round=e.round),t.a.score=e.b.score,t.b.score=e.a.score),t}),t}),I=x.sampledBy(D,function(t,e){return t.participants=t.participants.map(function(t){return t.id===e.id&&(t.name=e.to,t.label=new Handlebars.SafeString(d(t))),t}),t}),W=x.sampledBy(z,function(t,e){return t.matches=t.matches.map(function(t){return t.id===e.match&&(t.round=e.round),t}),t}),Bacon.mergeAll([T,R,I,A,W]).throttle(10).onValue(function(t){if(s)return s(k(t))}),T.merge(R).merge(A).throttle(10).onValue(function(t){return e.find(".standings").replaceWith(Q.standings(P,D,j,c(t.participants,t.matches),null))}),I.merge(T).merge(R).throttle(10).onValue(function(t){var e,a,n;if(a=t.matches.filter(function(t){return t.round}),n=t.matches.filter(function(t){return!t.round}),a.each(function(t){var e,a;return e=B(t.id),a=h.create(L,t).markup,e.length?e.replaceWith(a):N(t.round).append(a)}),n.size()>0||s)return(e=N(0)).show(),n.each(function(t){var a,n;return a=B(t.id),n=h.create(L,t).markup,a.length?a.replaceWith(n):e.append(n)})}),o.each(function(t){return P.push(t)}),u.each(function(t){return L.push(t)})},f={init:function(a){var n,r,i,s;return a=a||{},r=a.labeler||e,n=this,s=_(),i=_(),a.init&&(s=_(a.init.teams),i=_(a.init.matches).map(function(t){return t.a.team=a.init.teams[t.a.team],t.b.team=a.init.teams[t.b.team],t})),u(s),o(t('<div class="jqgroup"></div>').appendTo(n),s,i,a.save||null,r)}},t.fn.group=function(e){return f[e]?f[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?t.error("Method "+e+" does not exist on jQuery.group"):f.init.apply(this,arguments)}}(jQuery)}).call(this);